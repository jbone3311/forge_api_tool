<!-- Settings Modal -->
<div class="modal fade" id="settingsModal" tabindex="-1" aria-labelledby="settingsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="settingsModalLabel">
                    <i class="bi bi-gear"></i> Settings
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <ul class="nav nav-tabs" id="settingsTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="api-tab" data-bs-toggle="tab" data-bs-target="#api" type="button" role="tab">
                            <i class="bi bi-plug"></i> API Connection
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="generation-tab" data-bs-toggle="tab" data-bs-target="#generation" type="button" role="tab">
                            <i class="bi bi-magic"></i> Generation
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="output-tab" data-bs-toggle="tab" data-bs-target="#output" type="button" role="tab">
                            <i class="bi bi-folder"></i> Output
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="templates-tab" data-bs-toggle="tab" data-bs-target="#templates" type="button" role="tab">
                            <i class="bi bi-file-text"></i> Templates
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="advanced-tab" data-bs-toggle="tab" data-bs-target="#advanced" type="button" role="tab">
                            <i class="bi bi-sliders"></i> Advanced
                        </button>
                    </li>
                </ul>
                
                <div class="tab-content mt-3" id="settingsTabContent">
                    <!-- API Connection Tab -->
                    <div class="tab-pane fade show active" id="api" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="api-type" class="form-label">API Type</label>
                                <select class="form-select" id="api-type">
                                    <option value="local">Local API</option>
                                    <option value="rundiffusion">RunDiffusion</option>
                                    <option value="comfyui">ComfyUI</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="api-url" class="form-label">API URL</label>
                                <input type="url" class="form-control" id="api-url" placeholder="http://localhost:3000">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="api-timeout" class="form-label">Timeout (seconds)</label>
                                <input type="number" class="form-control" id="api-timeout" value="30" min="5" max="300">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="api-retries" class="form-label">Retry Attempts</label>
                                <input type="number" class="form-control" id="api-retries" value="3" min="1" max="10">
                            </div>
                            
                            <div class="col-12">
                                <button class="btn btn-primary" onclick="testConnection()">
                                    <i class="bi bi-arrow-repeat"></i> Test Connection
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Generation Tab -->
                    <div class="tab-pane fade" id="generation" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label for="default-steps" class="form-label">Default Steps</label>
                                <input type="number" class="form-control" id="default-steps" value="20" min="1" max="100">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-cfg" class="form-label">Default CFG Scale</label>
                                <input type="number" class="form-control" id="default-cfg" value="7.0" min="1" max="20" step="0.1">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-width" class="form-label">Default Width</label>
                                <input type="number" class="form-control" id="default-width" value="512" min="64" max="2048" step="64">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-height" class="form-label">Default Height</label>
                                <input type="number" class="form-control" id="default-height" value="512" min="64" max="2048" step="64">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="max-batch-size" class="form-label">Max Batch Size</label>
                                <input type="number" class="form-control" id="max-batch-size" value="4" min="1" max="10">
                            </div>
                            
                            <div class="col-md-6">
                                <label for="max-concurrent" class="form-label">Max Concurrent Jobs</label>
                                <input type="number" class="form-control" id="max-concurrent" value="2" min="1" max="5">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Output Tab -->
                    <div class="tab-pane fade" id="output" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-organize" checked>
                                    <label class="form-check-label" for="auto-organize">
                                        Auto-organize outputs by date
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="keep-metadata" checked>
                                    <label class="form-check-label" for="keep-metadata">
                                        Keep metadata in output files
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="compression-quality" class="form-label">Compression Quality</label>
                                <input type="range" class="form-range" id="compression-quality" min="1" max="100" value="95">
                                <div class="d-flex justify-content-between">
                                    <small>1</small>
                                    <small id="compression-value">95</small>
                                    <small>100</small>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="output-format" class="form-label">Output Format</label>
                                <select class="form-select" id="output-format">
                                    <option value="png">PNG</option>
                                    <option value="jpg">JPEG</option>
                                    <option value="webp">WebP</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Templates Tab -->
                    <div class="tab-pane fade" id="templates" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <h6 class="text-muted mb-3">Default Template Settings</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-model" class="form-label">Default Model</label>
                                <select class="form-select" id="default-model">
                                    <option value="sd_xl_base_1.0.safetensors">SDXL Base 1.0</option>
                                    <option value="sd_xl_refiner_1.0.safetensors">SDXL Refiner 1.0</option>
                                    <option value="sd_1.5.safetensors">SD 1.5</option>
                                    <option value="sd_2.1.safetensors">SD 2.1</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-sampler" class="form-label">Default Sampler</label>
                                <select class="form-select" id="default-sampler">
                                    <option value="euler">Euler</option>
                                    <option value="euler_a">Euler Ancestral</option>
                                    <option value="dpm++_2m">DPM++ 2M</option>
                                    <option value="dpm++_2s">DPM++ 2S</option>
                                    <option value="ddim">DDIM</option>
                                    <option value="plms">PLMS</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-scheduler" class="form-label">Default Scheduler</label>
                                <select class="form-select" id="default-scheduler">
                                    <option value="karras">Karras</option>
                                    <option value="exponential">Exponential</option>
                                    <option value="sgm_uniform">SGM Uniform</option>
                                    <option value="simple_linear">Simple Linear</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-seed" class="form-label">Default Seed</label>
                                <input type="number" class="form-control" id="default-seed" value="-1" min="-1" max="999999999">
                                <small class="form-text text-muted">-1 for random seed</small>
                            </div>
                            
                            <div class="col-12">
                                <h6 class="text-muted mb-3 mt-4">Template Behavior</h6>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-load-templates" checked>
                                    <label class="form-check-label" for="auto-load-templates">
                                        Auto-load templates on startup
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="template-validation" checked>
                                    <label class="form-check-label" for="template-validation">
                                        Validate templates before saving
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="template-backup" checked>
                                    <label class="form-check-label" for="template-backup">
                                        Create backup before template changes
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="template-cache-size" class="form-label">Template Cache Size</label>
                                <input type="number" class="form-control" id="template-cache-size" value="50" min="10" max="200">
                                <small class="form-text text-muted">Number of templates to keep in memory</small>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="template-auto-save" class="form-label">Auto-save Interval (minutes)</label>
                                <input type="number" class="form-control" id="template-auto-save" value="5" min="1" max="60">
                                <small class="form-text text-muted">How often to auto-save template changes</small>
                            </div>
                            
                            <div class="col-12">
                                <h6 class="text-muted mb-3 mt-4">Template Categories</h6>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="default-category" class="form-label">Default Category</label>
                                <select class="form-select" id="default-category">
                                    <option value="general">General</option>
                                    <option value="portrait">Portrait</option>
                                    <option value="landscape">Landscape</option>
                                    <option value="fantasy">Fantasy</option>
                                    <option value="sci-fi">Sci-Fi</option>
                                    <option value="anime">Anime</option>
                                    <option value="realistic">Realistic</option>
                                    <option value="artistic">Artistic</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="template-tags" class="form-label">Default Tags</label>
                                <input type="text" class="form-control" id="template-tags" placeholder="Enter comma-separated tags">
                                <small class="form-text text-muted">Default tags for new templates</small>
                            </div>
                            
                            <div class="col-12">
                                <h6 class="text-muted mb-3 mt-4">Template Management</h6>
                            </div>
                            
                            <div class="col-12">
                                <button class="btn btn-outline-primary" onclick="exportTemplates()">
                                    <i class="bi bi-download"></i> Export All Templates
                                </button>
                                <button class="btn btn-outline-secondary" onclick="importTemplates()">
                                    <i class="bi bi-upload"></i> Import Templates
                                </button>
                                <button class="btn btn-outline-warning" onclick="validateAllTemplates()">
                                    <i class="bi bi-check-circle"></i> Validate All Templates
                                </button>
                                <button class="btn btn-outline-danger" onclick="clearTemplateCache()">
                                    <i class="bi bi-trash"></i> Clear Template Cache
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Advanced Tab -->
                    <div class="tab-pane fade" id="advanced" role="tabpanel">
                        <div class="row g-3">
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="debug-mode">
                                    <label class="form-check-label" for="debug-mode">
                                        Enable debug mode
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="auto-save" checked>
                                    <label class="form-check-label" for="auto-save">
                                        Auto-save settings
                                    </label>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="log-level" class="form-label">Log Level</label>
                                <select class="form-select" id="log-level">
                                    <option value="info">Info</option>
                                    <option value="debug">Debug</option>
                                    <option value="warning">Warning</option>
                                    <option value="error">Error</option>
                                </select>
                            </div>
                            
                            <div class="col-md-6">
                                <label for="max-log-size" class="form-label">Max Log Size (MB)</label>
                                <input type="number" class="form-control" id="max-log-size" value="10" min="1" max="100">
                            </div>
                            
                            <div class="col-12">
                                <button class="btn btn-outline-secondary" onclick="exportLogs()">
                                    <i class="bi bi-download"></i> Export Logs
                                </button>
                                <button class="btn btn-outline-danger" onclick="clearLogs()">
                                    <i class="bi bi-trash"></i> Clear Logs
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="saveSettingsModal()">
                    <i class="bi bi-save"></i> Save Settings
                </button>
            </div>
        </div>
    </div>
</div>

<script>
// Settings modal functionality
document.addEventListener('DOMContentLoaded', () => {
    // Compression quality range slider
    const compressionSlider = document.getElementById('compression-quality');
    const compressionValue = document.getElementById('compression-value');
    
    if (compressionSlider && compressionValue) {
        compressionSlider.addEventListener('input', (e) => {
            compressionValue.textContent = e.target.value;
        });
    }
});

function testConnection() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Testing...';
    button.disabled = true;
    
    // Simulate connection test
    setTimeout(() => {
        button.innerHTML = '<i class="bi bi-check-circle"></i> Connected';
        button.className = 'btn btn-success';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.className = 'btn btn-primary';
            button.disabled = false;
        }, 2000);
    }, 1500);
}

function saveSettingsModal() {
    // Collect all settings from the modal
    const settings = {
        // API Settings
        api_type: document.getElementById('api-type').value,
        api_url: document.getElementById('api-url').value,
        api_timeout: parseInt(document.getElementById('api-timeout').value),
        api_retries: parseInt(document.getElementById('api-retries').value),
        
        // Generation Settings
        default_steps: parseInt(document.getElementById('default-steps').value),
        default_cfg: parseFloat(document.getElementById('default-cfg').value),
        default_width: parseInt(document.getElementById('default-width').value),
        default_height: parseInt(document.getElementById('default-height').value),
        max_batch_size: parseInt(document.getElementById('max-batch-size').value),
        max_concurrent: parseInt(document.getElementById('max-concurrent').value),
        
        // Output Settings
        auto_organize: document.getElementById('auto-organize').checked,
        keep_metadata: document.getElementById('keep-metadata').checked,
        compression_quality: parseInt(document.getElementById('compression-quality').value),
        output_format: document.getElementById('output-format').value,
        
        // Template Settings
        default_model: document.getElementById('default-model').value,
        default_sampler: document.getElementById('default-sampler').value,
        default_scheduler: document.getElementById('default-scheduler').value,
        default_seed: parseInt(document.getElementById('default-seed').value),
        auto_load_templates: document.getElementById('auto-load-templates').checked,
        template_validation: document.getElementById('template-validation').checked,
        template_backup: document.getElementById('template-backup').checked,
        template_cache_size: parseInt(document.getElementById('template-cache-size').value),
        template_auto_save: parseInt(document.getElementById('template-auto-save').value),
        default_category: document.getElementById('default-category').value,
        template_tags: document.getElementById('template-tags').value,
        
        // Advanced Settings
        debug_mode: document.getElementById('debug-mode').checked,
        auto_save: document.getElementById('auto-save').checked,
        log_level: document.getElementById('log-level').value,
        max_log_size: parseInt(document.getElementById('max-log-size').value)
    };
    
    // Save settings
    window.dashboard?.saveSettingsModal(settings);
    
    // Close modal
    const modal = bootstrap.Modal.getInstance(document.getElementById('settingsModal'));
    modal.hide();
}

// Template management functions
function exportTemplates() {
    window.dashboard?.exportTemplates();
}

function importTemplates() {
    // Create file input for template import
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json,.txt';
    input.multiple = true;
    
    input.onchange = (e) => {
        const files = Array.from(e.target.files);
        window.dashboard?.importTemplates(files);
    };
    
    input.click();
}

function validateAllTemplates() {
    const button = event.target;
    const originalText = button.innerHTML;
    
    button.innerHTML = '<i class="bi bi-arrow-clockwise spin"></i> Validating...';
    button.disabled = true;
    
    window.dashboard?.validateAllTemplates().then(() => {
        button.innerHTML = '<i class="bi bi-check-circle"></i> Validation Complete';
        button.className = 'btn btn-success';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.className = 'btn btn-outline-warning';
            button.disabled = false;
        }, 2000);
    }).catch((error) => {
        button.innerHTML = '<i class="bi bi-exclamation-triangle"></i> Validation Failed';
        button.className = 'btn btn-danger';
        
        setTimeout(() => {
            button.innerHTML = originalText;
            button.className = 'btn btn-outline-warning';
            button.disabled = false;
        }, 2000);
    });
}

function clearTemplateCache() {
    if (confirm('Are you sure you want to clear the template cache? This will reload all templates on next access.')) {
        window.dashboard?.clearTemplateCache();
    }
}

function exportLogs() {
    window.dashboard?.exportLogs();
}

function clearLogs() {
    if (confirm('Are you sure you want to clear all logs?')) {
        window.dashboard?.clearLogs();
    }
}
</script>

<style>
.spin {
    animation: spin 1s linear infinite;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}
</style> 
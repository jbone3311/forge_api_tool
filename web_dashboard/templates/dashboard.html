<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge API Tool Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1><i class="fas fa-magic"></i> Forge API Tool</h1>
                <div class="status-indicators">
                    <div class="status-item" id="api-status">
                        <i class="fas fa-circle status-icon"></i>
                        <span class="status-text">API: Checking...</span>
                    </div>
                    <div class="status-item" id="generation-status">
                        <i class="fas fa-spinner fa-spin status-icon"></i>
                        <span class="status-text">Generation: Idle</span>
                    </div>
                    <div class="status-item" id="queue-status">
                        <i class="fas fa-list status-icon"></i>
                        <span class="status-text">Queue: 0 jobs</span>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="openLiveStatusModal()" style="margin-left:1rem;">
                        <i class="fas fa-terminal"></i> Live Status
                    </button>
                    <button class="btn btn-sm btn-primary" id="api-connect-btn" onclick="toggleApiConnection()" style="margin-left:0.5rem;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Left Sidebar - Templates -->
            <aside class="sidebar templates-sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-layer-group"></i> Templates</h2>
                    <div class="sidebar-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshTemplates()" title="Refresh Templates">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-primary" onclick="showCreateTemplateModal()">
                            <i class="fas fa-plus"></i> New
                        </button>
                    </div>
                </div>
                
                <div class="templates-container">
                    <div class="templates-scroll">
                        {% if configs|length == 0 %}
                        <div class="text-center text-muted" style="margin-top:2rem; padding: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>No templates found.</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Please add configurations in the configs/ directory.</div>
                            {% if error %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #dc3545; background: #f8d7da; padding: 0.5rem; border-radius: 4px;">
                                <strong>Error:</strong> {{ error }}
                            </div>
                            {% endif %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #6c757d;">
                                <strong>Debug Info:</strong><br>
                                Configs loaded: {{ configs|length }}<br>
                                {% if configs %}
                                Available: {{ configs.keys()|list|join(', ') }}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #6c757d; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <i class="fas fa-check-circle"></i> Found {{ configs|length }} template(s)
                            <div style="font-size: 0.8rem; margin-top: 0.25rem; color: #495057;">
                                <i class="fas fa-mouse-pointer"></i> Click any template card to load its prompt
                            </div>
                        </div>
                        {% endif %}
                        {% for config_name, config in configs.items() %}
                        <div class="template-card" data-config="{{ config_name }}">
                            <div class="template-header">
                                <h3 class="template-name">{{ config.get('name', config_name) }}</h3>
                                <div class="template-actions">
                                    <button class="btn-icon" onclick="editTemplate('{{ config_name }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTemplate('{{ config_name }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="template-info">
                                <div class="template-field">
                                    <span class="field-label">Description:</span>
                                    <span class="field-value">{{ config.get('description', 'No description') }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Model:</span>
                                    <span class="field-value">{{ config.get('model_type', 'Unknown').upper() }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Checkpoint:</span>
                                    <span class="field-value">{{ config.get('model_settings', {}).get('checkpoint', 'Unknown') }}</span>
                                </div>
                            </div>
                            <div class="template-actions-bar">
                                <button class="btn btn-sm btn-primary" onclick="generateSingle('{{ config_name }}')">
                                    <i class="fas fa-play"></i> Generate
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="startBatch('{{ config_name }}')">
                                    <i class="fas fa-layer-group"></i> Batch
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </aside>

            <!-- Main Content Area -->
            <section class="main-content">
                <!-- Generation Progress -->
                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="progress-header">
                        <h3><i class="fas fa-cogs"></i> Generation Progress</h3>
                        <div class="progress-controls">
                            <span class="progress-config" id="progress-config"></span>
                            <button class="btn btn-sm btn-danger" onclick="stopGeneration()" id="stop-generation-btn">
                                <i class="fas fa-stop"></i> Stop Generation
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-text">0 / 0 images</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <span id="progress-time">Elapsed: 0s</span>
                        <span id="progress-eta">ETA: --</span>
                    </div>
                </div>

                <!-- Generation Controls -->
                <div class="generation-controls">
                    <div class="control-group">
                        <h3><i class="fas fa-magic"></i> Single Generation</h3>
                        <div class="input-group">
                            <label for="prompt-input">Prompt:</label>
                            <textarea id="prompt-input" placeholder="Enter your prompt here..."></textarea>
                        </div>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="seed-input">Seed:</label>
                                <input type="number" id="seed-input" placeholder="Random" min="-1" step="1" title="Enter a number for fixed seed, or leave empty for random">
                            </div>
                            <div class="input-group">
                                <label for="config-select">Template:</label>
                                <select id="config-select">
                                    <option value="">Select a template...</option>
                                    {% for config_name in configs.keys() %}
                                    <option value="{{ config_name }}">{{ config_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                        <button class="btn btn-primary btn-large" onclick="generateImage()">
                            <i class="fas fa-play"></i> Generate Image
                        </button>
                    </div>

                    <div class="control-group">
                        <h3><i class="fas fa-layer-group"></i> Batch Generation</h3>
                        <div class="input-row">
                            <div class="input-group">
                                <label for="batch-size">Batch Size:</label>
                                <input type="number" id="batch-size" value="4" min="1" max="10">
                            </div>
                            <div class="input-group">
                                <label for="num-batches">Number of Batches:</label>
                                <input type="number" id="num-batches" value="1" min="1" max="10">
                            </div>
                        </div>
                        <div class="batch-actions">
                            <button class="btn btn-secondary" onclick="previewBatch()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="btn btn-primary" onclick="startBatchGeneration()">
                                <i class="fas fa-play"></i> Start Batch
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Outputs Section -->
                <div class="outputs-section">
                    <div class="section-header">
                        <h3><i class="fas fa-images"></i> Recent Outputs</h3>
                        <div class="section-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshOutputs()">
                                <i class="fas fa-refresh"></i> Refresh
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="exportOutputs()">
                                <i class="fas fa-download"></i> Export
                            </button>
                        </div>
                    </div>
                    <div class="outputs-grid" id="outputs-grid">
                        <!-- Outputs will be loaded here -->
                    </div>
                </div>
            </section>

            <!-- Right Sidebar - Queue & Logs -->
            <aside class="sidebar info-sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-info-circle"></i> System Info</h2>
                </div>
                
                <!-- Queue Status -->
                <div class="info-card">
                    <h3><i class="fas fa-list"></i> Job Queue</h3>
                    <div class="queue-info">
                        <div class="queue-stat">
                            <span class="stat-label">Active Jobs:</span>
                            <span class="stat-value" id="queue-active">0</span>
                        </div>
                        <div class="queue-stat">
                            <span class="stat-label">Pending Jobs:</span>
                            <span class="stat-value" id="queue-pending">0</span>
                        </div>
                        <div class="queue-stat">
                            <span class="stat-label">Completed Jobs:</span>
                            <span class="stat-value" id="queue-completed">0</span>
                        </div>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="clearQueue()">
                        <i class="fas fa-trash"></i> Clear Queue
                    </button>
                </div>

                <!-- Output Statistics -->
                <div class="info-card">
                    <h3><i class="fas fa-chart-bar"></i> Output Stats</h3>
                    <div class="stats-info">
                        <div class="stat-item">
                            <span class="stat-label">Total Images:</span>
                            <span class="stat-value" id="total-images">{{ output_stats.get('total_outputs', 0) }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Today:</span>
                            <span class="stat-value" id="today-images">{{ output_stats.get('today_outputs', 0) }}</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-label">Storage Used:</span>
                            <span class="stat-value" id="storage-used">{{ output_stats.get('storage_used', '0 MB') }}</span>
                        </div>
                    </div>
                </div>

                <!-- Logs Section -->
                <div class="info-card">
                    <h3><i class="fas fa-file-alt"></i> Logs</h3>
                    <div class="logs-actions">
                        <button class="btn btn-sm btn-secondary" onclick="viewLogs()">
                            <i class="fas fa-eye"></i> View Logs
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="clearLogs()">
                            <i class="fas fa-trash"></i> Clear Logs
                        </button>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <div id="create-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Template</h3>
                <button class="close-btn" onclick="closeModal('create-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="template-name">Template Name:</label>
                    <input type="text" id="template-name" placeholder="Enter template name">
                </div>
                <div class="input-group">
                    <label for="template-config">Configuration (JSON):</label>
                    <textarea id="template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('create-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createTemplate()">Create</button>
            </div>
        </div>
    </div>

    <div id="edit-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Template</h3>
                <button class="close-btn" onclick="closeModal('edit-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-template-name">Template Name:</label>
                    <input type="text" id="edit-template-name" readonly>
                </div>
                <div class="input-group">
                    <label for="edit-template-config">Configuration (JSON):</label>
                    <textarea id="edit-template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateTemplate()">Update</button>
            </div>
        </div>
    </div>

    <div id="batch-preview-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Batch Preview</h3>
                <button class="close-btn" onclick="closeModal('batch-preview-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batch-preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('batch-preview-modal')">Close</button>
                <button class="btn btn-primary" onclick="confirmBatchGeneration()">Start Generation</button>
            </div>
        </div>
    </div>

    <div id="logs-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>System Logs</h3>
                <button class="close-btn" onclick="closeModal('logs-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="logs-content">
                    <!-- Logs will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logs-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Live Status Modal -->
    <div id="live-status-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Live Status</h3>
                <button class="close-btn" onclick="closeModal('live-status-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="live-status-content" style="font-family:monospace; font-size:0.95rem; max-height:400px; overflow-y:auto;">
                    <!-- Live status events will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('live-status-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html> 
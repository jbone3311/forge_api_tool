<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge API Tool Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1><i class="fas fa-magic"></i> Forge API Tool</h1>
                <div class="status-indicators">
                    <div class="status-item" id="api-status">
                        <i class="fas fa-circle status-icon"></i>
                        <span class="status-text">API: Checking...</span>
                    </div>
                    <div class="status-item" id="generation-status">
                        <i class="fas fa-spinner fa-spin status-icon"></i>
                        <span class="status-text">Generation: Idle</span>
                    </div>
                    <div class="status-item" id="queue-status">
                        <i class="fas fa-list status-icon"></i>
                        <span class="status-text">Queue: 0 jobs</span>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="openLiveStatusModal()" style="margin-left:1rem;">
                        <i class="fas fa-terminal"></i> Live Status
                    </button>
                    <button class="btn btn-sm btn-primary" id="api-connect-btn" onclick="toggleApiConnection()" style="margin-left:0.5rem;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                    <button class="btn btn-sm btn-secondary" onclick="openSettingsModal()" style="margin-left:0.5rem;" title="Settings">
                        <i class="fas fa-cog"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Left Sidebar - Templates -->
            <aside class="sidebar templates-sidebar resizable">
                <div class="sidebar-resizer" id="sidebar-resizer"></div>
                <div class="sidebar-header">
                    <h2><i class="fas fa-layer-group"></i> Templates</h2>
                    <div class="sidebar-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshTemplates()" title="Refresh Templates">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-primary" onclick="showCreateTemplateModal()">
                            <i class="fas fa-plus"></i> New
                        </button>
                    </div>
                </div>
                
                <div class="templates-container">
                    <div class="templates-scroll">
                        {% if configs|length == 0 %}
                        <div class="text-center text-muted" style="margin-top:2rem; padding: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>No templates found.</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Please add configurations in the configs/ directory.</div>
                            {% if error %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #dc3545; background: #f8d7da; padding: 0.5rem; border-radius: 4px;">
                                <strong>Error:</strong> {{ error }}
                            </div>
                            {% endif %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #6c757d;">
                                <strong>Debug Info:</strong><br>
                                Configs loaded: {{ configs|length }}<br>
                                {% if configs %}
                                Available: {{ configs.keys()|list|join(', ') }}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #6c757d; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <i class="fas fa-check-circle"></i> Found {{ configs|length }} template(s)
                            <div style="font-size: 0.8rem; margin-top: 0.25rem; color: #495057;">
                                <i class="fas fa-mouse-pointer"></i> Click any template card to load its prompt
                            </div>
                        </div>
                        {% endif %}
                        {% for config_name, config in configs.items() %}
                        <div class="template-card" data-config="{{ config_name }}">
                            <div class="template-header">
                                <h3 class="template-name">{{ config.get('name', config_name) }}</h3>
                                <div class="template-actions">
                                    <button class="btn-icon" onclick="editTemplate('{{ config_name }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTemplate('{{ config_name }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="template-info">
                                <div class="template-field">
                                    <span class="field-label">Description:</span>
                                    <span class="field-value">{{ config.get('description', 'No description') }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Model:</span>
                                    <span class="field-value">{{ config.get('model_type', 'Unknown').upper() }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Checkpoint:</span>
                                    <span class="field-value">{{ config.get('model_settings', {}).get('checkpoint', 'Unknown') }}</span>
                                </div>
                            </div>
                            <div class="template-actions-bar">
                                <button class="btn btn-sm btn-primary" onclick="generateSingle('{{ config_name }}')">
                                    <i class="fas fa-play"></i> Generate
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="startBatch('{{ config_name }}')">
                                    <i class="fas fa-layer-group"></i> Batch
                                </button>
                                <button class="btn btn-sm btn-info" onclick="openOutputFolder('{{ config_name }}')" title="Open Output Folder">
                                    <i class="fas fa-folder-open"></i> Folder
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </aside>

            <!-- Main Content Area - Generation Settings -->
            <section class="main-content">
                <!-- Generation Progress -->
                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="progress-header">
                        <h3><i class="fas fa-cogs"></i> Generation Progress</h3>
                        <div class="progress-controls">
                            <span class="progress-config" id="progress-config"></span>
                            <button class="btn btn-sm btn-danger" onclick="stopGeneration()" id="stop-generation-btn">
                                <i class="fas fa-stop"></i> Stop Generation
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-text">0 / 0 images</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <span id="progress-time">Elapsed: 0s</span>
                        <span id="progress-eta">ETA: --</span>
                    </div>
                </div>

                <!-- Generation Settings -->
                <div class="generation-settings">
                    <div class="settings-header">
                        <h3><i class="fas fa-cog"></i> Generation Settings</h3>
                        <div class="settings-actions">
                            <button class="btn btn-sm btn-secondary" onclick="loadDefaultSettings()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button class="btn btn-sm btn-info" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>

                    <!-- Basic Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-magic"></i> Basic Settings</h4>
                        <div class="settings-grid">
                            <div class="input-group prompt-group">
                                <label for="prompt-input">Prompt:</label>
                                <textarea id="prompt-input" placeholder="Enter your prompt here..."></textarea>
                            </div>
                            <div class="input-group">
                                <label for="negative-prompt-input">Negative Prompt:</label>
                                <textarea id="negative-prompt-input" placeholder="Enter negative prompt..."></textarea>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="config-select">Template:</label>
                                    <select id="config-select">
                                        <option value="">Select a template...</option>
                                        {% for config_name in configs.keys() %}
                                        <option value="{{ config_name }}">{{ config_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="seed-input">Seed:</label>
                                    <input type="number" id="seed-input" placeholder="Random" min="-1" step="1" title="Enter a number for fixed seed, or leave empty for random">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-image"></i> Image Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="width-input">Width:</label>
                                    <input type="number" id="width-input" value="512" min="64" max="2048" step="64">
                                </div>
                                <div class="input-group">
                                    <label for="height-input">Height:</label>
                                    <input type="number" id="height-input" value="512" min="64" max="2048" step="64">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="steps-input">Steps:</label>
                                    <input type="number" id="steps-input" value="20" min="1" max="150">
                                </div>
                                <div class="input-group">
                                    <label for="cfg-scale-input">CFG Scale:</label>
                                    <input type="number" id="cfg-scale-input" value="7.0" min="1.0" max="30.0" step="0.5">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="sampler-input">Sampler:</label>
                                    <select id="sampler-input">
                                        <option value="Euler a">Euler a</option>
                                        <option value="Euler">Euler</option>
                                        <option value="LMS">LMS</option>
                                        <option value="Heun">Heun</option>
                                        <option value="DPM2">DPM2</option>
                                        <option value="DPM2 a">DPM2 a</option>
                                        <option value="DPM++ 2S a">DPM++ 2S a</option>
                                        <option value="DPM++ 2M">DPM++ 2M</option>
                                        <option value="DPM++ SDE">DPM++ SDE</option>
                                        <option value="DPM fast">DPM fast</option>
                                        <option value="DPM adaptive">DPM adaptive</option>
                                        <option value="LMS Karras">LMS Karras</option>
                                        <option value="DPM2 Karras">DPM2 Karras</option>
                                        <option value="DPM2 a Karras">DPM2 a Karras</option>
                                        <option value="DPM++ 2S a Karras">DPM++ 2S a Karras</option>
                                        <option value="DPM++ 2M Karras">DPM++ 2M Karras</option>
                                        <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                                        <option value="DDIM">DDIM</option>
                                        <option value="PLMS">PLMS</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="batch-size-input">Batch Size:</label>
                                    <input type="number" id="batch-size-input" value="1" min="1" max="10">
                                </div>
                                <div class="input-group">
                                    <label for="num-batches">Number of Batches:</label>
                                    <input type="number" id="num-batches" value="1" min="1" max="10">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-sliders-h"></i> Advanced Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="restore-faces-input">Restore Faces:</label>
                                    <select id="restore-faces-input">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="tiling-input">Tiling:</label>
                                    <select id="tiling-input">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="clip-skip-input">Clip Skip:</label>
                                    <input type="number" id="clip-skip-input" value="1" min="1" max="12">
                                </div>
                                <div class="input-group">
                                    <label for="denoising-strength-input">Denoising Strength:</label>
                                    <input type="number" id="denoising-strength-input" value="0.7" min="0.0" max="1.0" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hires Fix Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-expand-arrows-alt"></i> Hires Fix Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="hires-fix-input">Hires Fix:</label>
                                    <select id="hires-fix-input">
                                        <option value="false">Disabled</option>
                                        <option value="true">Enabled</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="hires-upscaler-input">Hires Upscaler:</label>
                                    <select id="hires-upscaler-input">
                                        <option value="Latent">Latent</option>
                                        <option value="Latent (antialiased)">Latent (antialiased)</option>
                                        <option value="Latent (bicubic)">Latent (bicubic)</option>
                                        <option value="Latent (bicubic antialiased)">Latent (bicubic antialiased)</option>
                                        <option value="Latent (nearest)">Latent (nearest)</option>
                                        <option value="Latent (nearest-exact)">Latent (nearest-exact)</option>
                                        <option value="None">None</option>
                                        <option value="R-ESRGAN 4x+">R-ESRGAN 4x+</option>
                                        <option value="R-ESRGAN 4x+ Anime6B">R-ESRGAN 4x+ Anime6B</option>
                                        <option value="RealESRGAN_x4plus">RealESRGAN_x4plus</option>
                                        <option value="RealESRGAN_x4plus_anime_6B">RealESRGAN_x4plus_anime_6B</option>
                                        <option value="SwinIR_4x">SwinIR_4x</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="hires-steps-input">Hires Steps:</label>
                                    <input type="number" id="hires-steps-input" value="20" min="1" max="150">
                                </div>
                                <div class="input-group">
                                    <label for="hires-denoising-input">Hires Denoising:</label>
                                    <input type="number" id="hires-denoising-input" value="0.7" min="0.0" max="1.0" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Actions -->
                    <div class="generation-actions">
                        <button class="btn btn-primary btn-large" onclick="generateImage()">
                            <i class="fas fa-play"></i> Generate Image
                        </button>
                        <button class="btn btn-secondary" onclick="previewGeneration()" title="Preview generation settings">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn btn-info" onclick="startBatchGeneration()">
                            <i class="fas fa-layer-group"></i> Start Batch
                        </button>
                    </div>
                </div>
            </section>

            <!-- Right Sidebar - Queue, Outputs, etc. -->
            <aside class="sidebar queue-sidebar resizable">
                <div class="sidebar-resizer" id="queue-resizer"></div>
                
                <!-- Image Analysis Section -->
                <div class="image-analysis-section">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-search"></i> Image Analysis</h2>
                        <div class="sidebar-actions">
                            <button class="btn btn-sm btn-info" onclick="showAnalysisSummary()" title="Show Analysis Summary">
                                <i class="fas fa-list"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="clearImageAnalysis()" title="Clear Analysis">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Image Drop Zone -->
                    <div class="image-drop-zone dropzone" id="image-drop-zone">
                        <div class="drop-zone-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Drop an image here to analyze</h4>
                            <p>or click to select a file</p>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div class="analysis-results" id="analysis-results" style="display: none;">
                        <div class="analysis-header">
                            <h4><i class="fas fa-chart-bar"></i> Analysis Results</h4>
                            <button class="btn btn-sm btn-primary" onclick="populateSettingsFromAnalysis()">
                                <i class="fas fa-arrow-down"></i> Populate Settings
                            </button>
                        </div>
                        <div class="analysis-content" id="analysis-content">
                            <!-- Analysis results will be populated here -->
                        </div>
                    </div>
                </div>
                
                <!-- Queue Section -->
                <div class="queue-section">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-list"></i> Queue</h2>
                        <div class="sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshQueue()" title="Refresh Queue">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="clearQueue()" title="Clear Queue">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="queue-container">
                        <div class="queue-stats">
                            <span class="queue-count" id="queue-count">0 jobs</span>
                            <span class="queue-status" id="queue-status-text">Idle</span>
                        </div>
                        <div class="queue-jobs" id="queue-jobs">
                            <!-- Queue jobs will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Outputs Section -->
                <div class="outputs-section">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-images"></i> Outputs</h2>
                        <div class="sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshOutputs()" title="Refresh Outputs">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="openOutputsFolder()" title="Open Outputs Folder">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="outputs-container">
                        <div class="outputs-stats">
                            <span class="outputs-count" id="outputs-count">0 images</span>
                            <span class="outputs-date" id="outputs-date">Today</span>
                        </div>
                        <div class="outputs-gallery" id="outputs-gallery">
                            <!-- Output images will be populated here -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Template Modal -->
    <div id="create-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Template</h3>
                <button class="close-btn" onclick="closeModal('create-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="template-name">Template Name:</label>
                    <input type="text" id="template-name" placeholder="Enter template name">
                </div>
                <div class="input-group">
                    <label for="template-config">Configuration (JSON):</label>
                    <textarea id="template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('create-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createTemplate()">Create</button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="edit-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Template</h3>
                <button class="close-btn" onclick="closeModal('edit-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-template-name">Template Name:</label>
                    <input type="text" id="edit-template-name" readonly>
                </div>
                <div class="input-group">
                    <label for="edit-template-config">Configuration (JSON):</label>
                    <textarea id="edit-template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateTemplate()">Update</button>
            </div>
        </div>
    </div>

    <!-- Batch Preview Modal -->
    <div id="batch-preview-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Batch Preview</h3>
                <button class="close-btn" onclick="closeModal('batch-preview-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batch-preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('batch-preview-modal')">Close</button>
                <button class="btn btn-primary" onclick="confirmBatchGeneration()">Start Generation</button>
            </div>
        </div>
    </div>

    <!-- Live Status Modal -->
    <div id="live-status-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Live Status</h3>
                <button class="close-btn" onclick="closeModal('live-status-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="live-status-content" style="font-family:monospace; font-size:0.95rem; max-height:400px; overflow-y:auto;">
                    <!-- Live status events will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('live-status-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Config from Analysis Modal -->
    <div id="create-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Config from Analysis</h3>
                <button class="close-btn" onclick="closeModal('create-config-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="new-config-name">Config Name:</label>
                    <input type="text" id="new-config-name" placeholder="Enter config name">
                </div>
                <div class="input-group">
                    <label for="new-config-description">Description:</label>
                    <textarea id="new-config-description" placeholder="Enter description"></textarea>
                </div>
                <div class="analysis-summary">
                    <h5>Analysis Summary:</h5>
                    <div id="create-config-summary">
                        <!-- Analysis summary will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('create-config-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCreateConfig()">Create Config</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-cog"></i> Settings</h3>
                <button class="close-btn" onclick="closeModal('settings-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="settings-tabs">
                    <button class="tab-btn active" onclick="switchSettingsTab('api')">API Configuration</button>
                    <button class="tab-btn" onclick="switchSettingsTab('output')">Output Settings</button>
                    <button class="tab-btn" onclick="switchSettingsTab('logs')">Logs & Maintenance</button>
                    <button class="tab-btn" onclick="switchSettingsTab('advanced')">Advanced</button>
                </div>

                <!-- API Configuration Tab -->
                <div id="api-settings-tab" class="settings-tab active">
                    <div class="settings-section">
                        <h4><i class="fas fa-server"></i> API Configuration</h4>
                        
                        <div class="api-type-selector">
                            <label class="radio-label">
                                <input type="radio" name="api-type" value="local" id="api-local">
                                <span class="radio-custom"></span>
                                Local Forge API
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="api-type" value="rundiffusion" id="api-rundiffusion">
                                <span class="radio-custom"></span>
                                RunDiffusion API
                            </label>
                        </div>

                        <!-- Local API Settings -->
                        <div id="local-api-settings" class="api-settings-panel">
                            <div class="input-group">
                                <label for="local-api-url">Local API URL:</label>
                                <input type="url" id="local-api-url" placeholder="http://localhost:3000" value="http://localhost:3000">
                            </div>
                            <div class="input-group">
                                <label for="local-api-timeout">Timeout (seconds):</label>
                                <input type="number" id="local-api-timeout" value="30" min="5" max="300">
                            </div>
                        </div>

                        <!-- RunDiffusion API Settings -->
                        <div id="rundiffusion-api-settings" class="api-settings-panel" style="display: none;">
                            <div class="input-group">
                                <label for="rundiffusion-url-settings">Server URL:</label>
                                <input type="url" id="rundiffusion-url-settings" placeholder="https://your-instance.rundiffusion.com">
                            </div>
                            <div class="input-group">
                                <label for="rundiffusion-username-settings">Username:</label>
                                <input type="text" id="rundiffusion-username-settings" placeholder="rduser">
                            </div>
                            <div class="input-group">
                                <label for="rundiffusion-password-settings">Password:</label>
                                <input type="password" id="rundiffusion-password-settings" placeholder="rdpass">
                            </div>
                            <div class="input-group">
                                <label for="rundiffusion-timeout-settings">Timeout (seconds):</label>
                                <input type="number" id="rundiffusion-timeout-settings" value="60" min="10" max="300">
                            </div>
                        </div>

                        <div class="api-actions">
                            <button class="btn btn-sm btn-primary" onclick="saveApiSettings()">
                                <i class="fas fa-save"></i> Save API Settings
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="testApiConnection()">
                                <i class="fas fa-plug"></i> Test Connection
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Output Settings Tab -->
                <div id="output-settings-tab" class="settings-tab">
                    <div class="settings-section">
                        <h4><i class="fas fa-folder-open"></i> Output Directory Settings</h4>
                        
                        <div class="input-group">
                            <label for="output-base-directory">Base Output Directory:</label>
                            <div class="input-with-button">
                                <input type="text" id="output-base-directory" placeholder="/path/to/outputs" readonly>
                                <button class="btn btn-sm btn-secondary" onclick="selectOutputDirectory()">
                                    <i class="fas fa-folder-open"></i> Browse
                                </button>
                            </div>
                        </div>

                        <div class="input-group">
                            <label for="output-naming-pattern">File Naming Pattern:</label>
                            <select id="output-naming-pattern">
                                <option value="timestamp">Timestamp (YYYY-MM-DD_HH-MM-SS)</option>
                                <option value="config_timestamp">Config_Timestamp</option>
                                <option value="prompt_hash">Prompt Hash</option>
                                <option value="custom">Custom Pattern</option>
                            </select>
                        </div>

                        <div class="input-group" id="custom-pattern-group" style="display: none;">
                            <label for="custom-naming-pattern">Custom Pattern:</label>
                            <input type="text" id="custom-naming-pattern" placeholder="{config}_{timestamp}_{seed}">
                            <small class="help-text">Available variables: {config}, {timestamp}, {seed}, {prompt_hash}</small>
                        </div>

                        <div class="input-group">
                            <label for="auto-open-outputs">Auto-open output folder after generation:</label>
                            <select id="auto-open-outputs">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="max-outputs-display">Max outputs to display in gallery:</label>
                            <input type="number" id="max-outputs-display" value="50" min="10" max="200">
                        </div>
                    </div>
                </div>

                <!-- Logs & Maintenance Tab -->
                <div id="logs-settings-tab" class="settings-tab">
                    <div class="settings-section">
                        <h4><i class="fas fa-file-alt"></i> Log Management</h4>
                        
                        <div class="log-stats">
                            <div class="stat-item">
                                <span class="stat-label">Application Logs:</span>
                                <span class="stat-value" id="app-logs-size">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Error Logs:</span>
                                <span class="stat-value" id="error-logs-size">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Performance Logs:</span>
                                <span class="stat-value" id="perf-logs-size">--</span>
                            </div>
                        </div>

                        <div class="log-actions">
                            <button class="btn btn-sm btn-info" onclick="viewLogs()">
                                <i class="fas fa-eye"></i> View Logs
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="downloadLogs()">
                                <i class="fas fa-download"></i> Download Logs
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="clearLogs()">
                                <i class="fas fa-trash"></i> Clear All Logs
                            </button>
                        </div>

                        <div class="input-group">
                            <label for="log-retention-days">Log Retention (days):</label>
                            <input type="number" id="log-retention-days" value="30" min="1" max="365">
                        </div>

                        <div class="input-group">
                            <label for="auto-cleanup-logs">Auto-cleanup old logs:</label>
                            <select id="auto-cleanup-logs">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-database"></i> Cache Management</h4>
                        
                        <div class="cache-stats">
                            <div class="stat-item">
                                <span class="stat-label">Cache Size:</span>
                                <span class="stat-value" id="cache-size">--</span>
                            </div>
                            <div class="stat-item">
                                <span class="stat-label">Cache Items:</span>
                                <span class="stat-value" id="cache-items">--</span>
                            </div>
                        </div>

                        <div class="cache-actions">
                            <button class="btn btn-sm btn-warning" onclick="clearCache()">
                                <i class="fas fa-broom"></i> Clear Cache
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Advanced Settings Tab -->
                <div id="advanced-settings-tab" class="settings-tab">
                    <div class="settings-section">
                        <h4><i class="fas fa-sliders-h"></i> Performance Settings</h4>
                        
                        <div class="input-group">
                            <label for="max-concurrent-jobs">Max Concurrent Jobs:</label>
                            <input type="number" id="max-concurrent-jobs" value="2" min="1" max="10">
                        </div>

                        <div class="input-group">
                            <label for="job-timeout">Job Timeout (minutes):</label>
                            <input type="number" id="job-timeout" value="30" min="5" max="120">
                        </div>

                        <div class="input-group">
                            <label for="auto-refresh-interval">Auto-refresh Interval (seconds):</label>
                            <input type="number" id="auto-refresh-interval" value="5" min="1" max="60">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-shield-alt"></i> Security Settings</h4>
                        
                        <div class="input-group">
                            <label for="enable-cors">Enable CORS:</label>
                            <select id="enable-cors">
                                <option value="true">Yes</option>
                                <option value="false">No</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="max-upload-size">Max Upload Size (MB):</label>
                            <input type="number" id="max-upload-size" value="10" min="1" max="100">
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4><i class="fas fa-palette"></i> UI Settings</h4>
                        
                        <div class="input-group">
                            <label for="theme">Theme:</label>
                            <select id="theme">
                                <option value="light">Light</option>
                                <option value="dark">Dark</option>
                                <option value="auto">Auto (System)</option>
                            </select>
                        </div>

                        <div class="input-group">
                            <label for="sidebar-width">Default Sidebar Width (px):</label>
                            <input type="number" id="sidebar-width" value="300" min="200" max="500">
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('settings-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="saveAllSettings()">
                    <i class="fas fa-save"></i> Save All Settings
                </button>
            </div>
        </div>
    </div>

    <!-- Logs Modal -->
    <div id="logs-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3><i class="fas fa-file-alt"></i> Application Logs</h3>
                <button class="close-btn" onclick="closeModal('logs-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="logs-tabs">
                    <button class="tab-btn active" onclick="switchLogsTab('application')">Application</button>
                    <button class="tab-btn" onclick="switchLogsTab('errors')">Errors</button>
                    <button class="tab-btn" onclick="switchLogsTab('performance')">Performance</button>
                </div>
                <div class="logs-content">
                    <div id="application-logs" class="log-content active">
                        <pre id="app-logs-content"></pre>
                    </div>
                    <div id="error-logs" class="log-content">
                        <pre id="error-logs-content"></pre>
                    </div>
                    <div id="performance-logs" class="log-content">
                        <pre id="perf-logs-content"></pre>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('logs-modal')">Close</button>
                <button class="btn btn-info" onclick="refreshLogs()">
                    <i class="fas fa-sync-alt"></i> Refresh
                </button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script type="module" src="{{ url_for('static', filename='js/dashboard-modular.js') }}"></script>
    <script>
        // Simple test to verify JavaScript is working
        console.log('Dashboard HTML loaded');
        console.log('User Agent:', navigator.userAgent);
        
        // Safari-specific error handling
        if (navigator.userAgent.includes('Safari') && !navigator.userAgent.includes('Chrome')) {
            console.log('Safari detected - using Safari-specific handling');
        }
        
        // Test if modules are loading
        setTimeout(() => {
            console.log('Checking modules...');
            const modules = ['notificationManager', 'modalManager', 'templateManager', 'generationManager', 'queueManager', 'outputManager', 'settingsManager', 'analysisManager', 'utilsManager'];
            let loadedCount = 0;
            modules.forEach(moduleName => {
                if (window[moduleName]) {
                    console.log(`✓ ${moduleName} loaded`);
                    loadedCount++;
                } else {
                    console.error(`✗ ${moduleName} NOT loaded`);
                }
            });
            
            if (loadedCount === modules.length) {
                console.log('🎉 All modules loaded successfully!');
            } else {
                console.error(`⚠️ Only ${loadedCount}/${modules.length} modules loaded`);
            }
        }, 2000); // Increased timeout for Safari
    </script>
</body>
</html> 
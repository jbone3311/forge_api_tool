<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Forge API Tool Dashboard</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/dashboard.css') }}">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="dashboard-container">
        <!-- Header -->
        <header class="dashboard-header">
            <div class="header-content">
                <h1><i class="fas fa-magic"></i> Forge API Tool</h1>
                <div class="status-indicators">
                    <div class="status-item" id="api-status">
                        <i class="fas fa-circle status-icon"></i>
                        <span class="status-text">API: Checking...</span>
                    </div>
                    <div class="status-item" id="generation-status">
                        <i class="fas fa-spinner fa-spin status-icon"></i>
                        <span class="status-text">Generation: Idle</span>
                    </div>
                    <div class="status-item" id="queue-status">
                        <i class="fas fa-list status-icon"></i>
                        <span class="status-text">Queue: 0 jobs</span>
                    </div>
                    <button class="btn btn-sm btn-secondary" onclick="openLiveStatusModal()" style="margin-left:1rem;">
                        <i class="fas fa-terminal"></i> Live Status
                    </button>
                    <button class="btn btn-sm btn-primary" id="api-connect-btn" onclick="toggleApiConnection()" style="margin-left:0.5rem;">
                        <i class="fas fa-plug"></i> Connect
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="dashboard-main">
            <!-- Left Sidebar - Templates -->
            <aside class="sidebar templates-sidebar resizable">
                <div class="sidebar-resizer" id="sidebar-resizer"></div>
                <div class="sidebar-header">
                    <h2><i class="fas fa-layer-group"></i> Templates</h2>
                    <div class="sidebar-actions">
                        <button class="btn btn-sm btn-secondary" onclick="refreshTemplates()" title="Refresh Templates">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                        <button class="btn btn-primary" onclick="showCreateTemplateModal()">
                            <i class="fas fa-plus"></i> New
                        </button>
                    </div>
                </div>
                
                <div class="templates-container">
                    <div class="templates-scroll">
                        {% if configs|length == 0 %}
                        <div class="text-center text-muted" style="margin-top:2rem; padding: 1rem;">
                            <i class="fas fa-exclamation-triangle" style="font-size: 2rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <div>No templates found.</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Please add configurations in the configs/ directory.</div>
                            {% if error %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #dc3545; background: #f8d7da; padding: 0.5rem; border-radius: 4px;">
                                <strong>Error:</strong> {{ error }}
                            </div>
                            {% endif %}
                            <div style="font-size: 0.8rem; margin-top: 1rem; color: #6c757d;">
                                <strong>Debug Info:</strong><br>
                                Configs loaded: {{ configs|length }}<br>
                                {% if configs %}
                                Available: {{ configs.keys()|list|join(', ') }}
                                {% endif %}
                            </div>
                        </div>
                        {% else %}
                        <div style="margin-bottom: 1rem; font-size: 0.9rem; color: #6c757d; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                            <i class="fas fa-check-circle"></i> Found {{ configs|length }} template(s)
                            <div style="font-size: 0.8rem; margin-top: 0.25rem; color: #495057;">
                                <i class="fas fa-mouse-pointer"></i> Click any template card to load its prompt
                            </div>
                        </div>
                        {% endif %}
                        {% for config_name, config in configs.items() %}
                        <div class="template-card" data-config="{{ config_name }}">
                            <div class="template-header">
                                <h3 class="template-name">{{ config.get('name', config_name) }}</h3>
                                <div class="template-actions">
                                    <button class="btn-icon" onclick="editTemplate('{{ config_name }}')" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn-icon" onclick="deleteTemplate('{{ config_name }}')" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="template-info">
                                <div class="template-field">
                                    <span class="field-label">Description:</span>
                                    <span class="field-value">{{ config.get('description', 'No description') }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Model:</span>
                                    <span class="field-value">{{ config.get('model_type', 'Unknown').upper() }}</span>
                                </div>
                                <div class="template-field">
                                    <span class="field-label">Checkpoint:</span>
                                    <span class="field-value">{{ config.get('model_settings', {}).get('checkpoint', 'Unknown') }}</span>
                                </div>
                            </div>
                            <div class="template-actions-bar">
                                <button class="btn btn-sm btn-primary" onclick="generateSingle('{{ config_name }}')">
                                    <i class="fas fa-play"></i> Generate
                                </button>
                                <button class="btn btn-sm btn-secondary" onclick="startBatch('{{ config_name }}')">
                                    <i class="fas fa-layer-group"></i> Batch
                                </button>
                                <button class="btn btn-sm btn-info" onclick="openOutputFolder('{{ config_name }}')" title="Open Output Folder">
                                    <i class="fas fa-folder-open"></i> Folder
                                </button>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </aside>

            <!-- Main Content Area - Generation Settings -->
            <section class="main-content">
                <!-- Generation Progress -->
                <div class="progress-section" id="progress-section" style="display: none;">
                    <div class="progress-header">
                        <h3><i class="fas fa-cogs"></i> Generation Progress</h3>
                        <div class="progress-controls">
                            <span class="progress-config" id="progress-config"></span>
                            <button class="btn btn-sm btn-danger" onclick="stopGeneration()" id="stop-generation-btn">
                                <i class="fas fa-stop"></i> Stop Generation
                            </button>
                        </div>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar">
                            <div class="progress-fill" id="progress-fill"></div>
                        </div>
                        <div class="progress-text">
                            <span id="progress-text">0 / 0 images</span>
                            <span id="progress-percentage">0%</span>
                        </div>
                    </div>
                    <div class="progress-details">
                        <span id="progress-time">Elapsed: 0s</span>
                        <span id="progress-eta">ETA: --</span>
                    </div>
                </div>

                <!-- Generation Settings -->
                <div class="generation-settings">
                    <div class="settings-header">
                        <h3><i class="fas fa-cog"></i> Generation Settings</h3>
                        <div class="settings-actions">
                            <button class="btn btn-sm btn-secondary" onclick="loadDefaultSettings()">
                                <i class="fas fa-undo"></i> Reset
                            </button>
                            <button class="btn btn-sm btn-info" onclick="saveSettings()">
                                <i class="fas fa-save"></i> Save
                            </button>
                        </div>
                    </div>

                    <!-- Basic Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-magic"></i> Basic Settings</h4>
                        <div class="settings-grid">
                            <div class="input-group prompt-group">
                                <label for="prompt-input">Prompt:</label>
                                <textarea id="prompt-input" placeholder="Enter your prompt here..."></textarea>
                            </div>
                            <div class="input-group">
                                <label for="negative-prompt-input">Negative Prompt:</label>
                                <textarea id="negative-prompt-input" placeholder="Enter negative prompt..."></textarea>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="config-select">Template:</label>
                                    <select id="config-select">
                                        <option value="">Select a template...</option>
                                        {% for config_name in configs.keys() %}
                                        <option value="{{ config_name }}">{{ config_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="seed-input">Seed:</label>
                                    <input type="number" id="seed-input" placeholder="Random" min="-1" step="1" title="Enter a number for fixed seed, or leave empty for random">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Image Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-image"></i> Image Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="width-input">Width:</label>
                                    <input type="number" id="width-input" value="512" min="64" max="2048" step="64">
                                </div>
                                <div class="input-group">
                                    <label for="height-input">Height:</label>
                                    <input type="number" id="height-input" value="512" min="64" max="2048" step="64">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="steps-input">Steps:</label>
                                    <input type="number" id="steps-input" value="20" min="1" max="150">
                                </div>
                                <div class="input-group">
                                    <label for="cfg-scale-input">CFG Scale:</label>
                                    <input type="number" id="cfg-scale-input" value="7.0" min="1.0" max="30.0" step="0.5">
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="sampler-input">Sampler:</label>
                                    <select id="sampler-input">
                                        <option value="Euler a">Euler a</option>
                                        <option value="Euler">Euler</option>
                                        <option value="LMS">LMS</option>
                                        <option value="Heun">Heun</option>
                                        <option value="DPM2">DPM2</option>
                                        <option value="DPM2 a">DPM2 a</option>
                                        <option value="DPM++ 2S a">DPM++ 2S a</option>
                                        <option value="DPM++ 2M">DPM++ 2M</option>
                                        <option value="DPM++ SDE">DPM++ SDE</option>
                                        <option value="DPM fast">DPM fast</option>
                                        <option value="DPM adaptive">DPM adaptive</option>
                                        <option value="LMS Karras">LMS Karras</option>
                                        <option value="DPM2 Karras">DPM2 Karras</option>
                                        <option value="DPM2 a Karras">DPM2 a Karras</option>
                                        <option value="DPM++ 2S a Karras">DPM++ 2S a Karras</option>
                                        <option value="DPM++ 2M Karras">DPM++ 2M Karras</option>
                                        <option value="DPM++ SDE Karras">DPM++ SDE Karras</option>
                                        <option value="DDIM">DDIM</option>
                                        <option value="PLMS">PLMS</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="batch-size-input">Batch Size:</label>
                                    <input type="number" id="batch-size-input" value="1" min="1" max="10">
                                </div>
                                <div class="input-group">
                                    <label for="num-batches">Number of Batches:</label>
                                    <input type="number" id="num-batches" value="1" min="1" max="10">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-sliders-h"></i> Advanced Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="restore-faces-input">Restore Faces:</label>
                                    <select id="restore-faces-input">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="tiling-input">Tiling:</label>
                                    <select id="tiling-input">
                                        <option value="false">No</option>
                                        <option value="true">Yes</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="clip-skip-input">Clip Skip:</label>
                                    <input type="number" id="clip-skip-input" value="1" min="1" max="12">
                                </div>
                                <div class="input-group">
                                    <label for="denoising-strength-input">Denoising Strength:</label>
                                    <input type="number" id="denoising-strength-input" value="0.7" min="0.0" max="1.0" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Hires Fix Settings -->
                    <div class="settings-section">
                        <h4><i class="fas fa-expand-arrows-alt"></i> Hires Fix Settings</h4>
                        <div class="settings-grid">
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="hires-fix-input">Hires Fix:</label>
                                    <select id="hires-fix-input">
                                        <option value="false">Disabled</option>
                                        <option value="true">Enabled</option>
                                    </select>
                                </div>
                                <div class="input-group">
                                    <label for="hires-upscaler-input">Hires Upscaler:</label>
                                    <select id="hires-upscaler-input">
                                        <option value="Latent">Latent</option>
                                        <option value="Latent (antialiased)">Latent (antialiased)</option>
                                        <option value="Latent (bicubic)">Latent (bicubic)</option>
                                        <option value="Latent (bicubic antialiased)">Latent (bicubic antialiased)</option>
                                        <option value="Latent (nearest)">Latent (nearest)</option>
                                        <option value="Latent (nearest-exact)">Latent (nearest-exact)</option>
                                        <option value="None">None</option>
                                        <option value="R-ESRGAN 4x+">R-ESRGAN 4x+</option>
                                        <option value="R-ESRGAN 4x+ Anime6B">R-ESRGAN 4x+ Anime6B</option>
                                        <option value="RealESRGAN_x4plus">RealESRGAN_x4plus</option>
                                        <option value="RealESRGAN_x4plus_anime_6B">RealESRGAN_x4plus_anime_6B</option>
                                        <option value="SwinIR_4x">SwinIR_4x</option>
                                    </select>
                                </div>
                            </div>
                            <div class="input-row">
                                <div class="input-group">
                                    <label for="hires-steps-input">Hires Steps:</label>
                                    <input type="number" id="hires-steps-input" value="20" min="1" max="150">
                                </div>
                                <div class="input-group">
                                    <label for="hires-denoising-input">Hires Denoising:</label>
                                    <input type="number" id="hires-denoising-input" value="0.7" min="0.0" max="1.0" step="0.01">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Generation Actions -->
                    <div class="generation-actions">
                        <button class="btn btn-primary btn-large" onclick="generateImage()">
                            <i class="fas fa-play"></i> Generate Image
                        </button>
                        <button class="btn btn-secondary" onclick="previewGeneration()" title="Preview generation settings">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                        <button class="btn btn-info" onclick="startBatchGeneration()">
                            <i class="fas fa-layer-group"></i> Start Batch
                        </button>
                    </div>
                </div>

                <!-- Image Analysis Section -->
                <div class="image-analysis-section">
                    <div class="section-header">
                        <h3><i class="fas fa-microscope"></i> Image Analysis & Config Creation</h3>
                        <div class="section-actions">
                            <button class="btn btn-sm btn-info" onclick="showAnalysisSummary()" title="Show Analysis Summary">
                                <i class="fas fa-list"></i> Summary
                            </button>
                            <button class="btn btn-sm btn-secondary" onclick="clearImageAnalysis()">
                                <i class="fas fa-trash"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <!-- Image Drop Zone -->
                    <div class="image-drop-zone" id="image-drop-zone">
                        <div class="drop-zone-content">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <h4>Drop an image here to analyze</h4>
                            <p>or click to select a file</p>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                        </div>
                    </div>
                    
                    <!-- Analysis Results -->
                    <div class="analysis-results" id="analysis-results" style="display: none;">
                        <div class="analysis-header">
                            <h4><i class="fas fa-chart-bar"></i> Analysis Results</h4>
                            <button class="btn btn-sm btn-primary" onclick="populateSettingsFromAnalysis()">
                                <i class="fas fa-arrow-down"></i> Populate Settings
                            </button>
                        </div>
                        <div class="analysis-content" id="analysis-content">
                            <!-- Analysis results will be populated here -->
                        </div>
                    </div>
                </div>
            </section>

            <!-- Right Sidebar - Queue & Outputs -->
            <aside class="sidebar queue-sidebar resizable">
                <div class="sidebar-resizer" id="queue-resizer"></div>
                
                <!-- Queue Section -->
                <div class="queue-section">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-list"></i> Queue</h2>
                        <div class="sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshQueue()" title="Refresh Queue">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-danger" onclick="clearQueue()" title="Clear Queue">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="queue-container">
                        <div class="queue-stats">
                            <span class="queue-count" id="queue-count">0 jobs</span>
                            <span class="queue-status" id="queue-status-text">Idle</span>
                        </div>
                        <div class="queue-jobs" id="queue-jobs">
                            <!-- Queue jobs will be populated here -->
                        </div>
                    </div>
                </div>

                <!-- Outputs Section -->
                <div class="outputs-section">
                    <div class="sidebar-header">
                        <h2><i class="fas fa-images"></i> Outputs</h2>
                        <div class="sidebar-actions">
                            <button class="btn btn-sm btn-secondary" onclick="refreshOutputs()" title="Refresh Outputs">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                            <button class="btn btn-sm btn-info" onclick="openOutputsFolder()" title="Open Outputs Folder">
                                <i class="fas fa-folder-open"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="outputs-container">
                        <div class="outputs-stats">
                            <span class="outputs-count" id="outputs-count">0 images</span>
                            <span class="outputs-date" id="outputs-date">Today</span>
                        </div>
                        <div class="outputs-gallery" id="outputs-gallery">
                            <!-- Output images will be populated here -->
                        </div>
                    </div>
                </div>
            </aside>
        </main>
    </div>

    <!-- Modals -->
    <!-- Create Template Modal -->
    <div id="create-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create New Template</h3>
                <button class="close-btn" onclick="closeModal('create-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="template-name">Template Name:</label>
                    <input type="text" id="template-name" placeholder="Enter template name">
                </div>
                <div class="input-group">
                    <label for="template-config">Configuration (JSON):</label>
                    <textarea id="template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('create-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="createTemplate()">Create</button>
            </div>
        </div>
    </div>

    <!-- Edit Template Modal -->
    <div id="edit-template-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Edit Template</h3>
                <button class="close-btn" onclick="closeModal('edit-template-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="edit-template-name">Template Name:</label>
                    <input type="text" id="edit-template-name" readonly>
                </div>
                <div class="input-group">
                    <label for="edit-template-config">Configuration (JSON):</label>
                    <textarea id="edit-template-config" placeholder="Enter configuration JSON..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('edit-template-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="updateTemplate()">Update</button>
            </div>
        </div>
    </div>

    <!-- Batch Preview Modal -->
    <div id="batch-preview-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Batch Preview</h3>
                <button class="close-btn" onclick="closeModal('batch-preview-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="batch-preview-content">
                    <!-- Preview content will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('batch-preview-modal')">Close</button>
                <button class="btn btn-primary" onclick="confirmBatchGeneration()">Start Generation</button>
            </div>
        </div>
    </div>

    <!-- Live Status Modal -->
    <div id="live-status-modal" class="modal">
        <div class="modal-content modal-large">
            <div class="modal-header">
                <h3>Live Status</h3>
                <button class="close-btn" onclick="closeModal('live-status-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="live-status-content" style="font-family:monospace; font-size:0.95rem; max-height:400px; overflow-y:auto;">
                    <!-- Live status events will be loaded here -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('live-status-modal')">Close</button>
            </div>
        </div>
    </div>

    <!-- Create Config from Analysis Modal -->
    <div id="create-config-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Create Config from Analysis</h3>
                <button class="close-btn" onclick="closeModal('create-config-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="new-config-name">Config Name:</label>
                    <input type="text" id="new-config-name" placeholder="Enter config name">
                </div>
                <div class="input-group">
                    <label for="new-config-description">Description:</label>
                    <textarea id="new-config-description" placeholder="Enter description"></textarea>
                </div>
                <div class="analysis-summary">
                    <h5>Analysis Summary:</h5>
                    <div id="create-config-summary">
                        <!-- Analysis summary will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('create-config-modal')">Cancel</button>
                <button class="btn btn-primary" onclick="confirmCreateConfig()">Create Config</button>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script src="{{ url_for('static', filename='js/dashboard.js') }}"></script>
</body>
</html> 